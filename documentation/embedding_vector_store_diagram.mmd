graph TB
    subgraph "Embedding Service Layer"
        ES[EmbeddingService]
        ST[SentenceTransformer Model<br/>all-MiniLM-L6-v2<br/>384 dimensions]
        ES -->|loads| ST
        
        ET[embed_text<br/>Single text → Vector]
        ETS[embed_texts<br/>Batch texts → Vectors]
        ES --> ET
        ES --> ETS
        ST -->|encodes| ET
        ST -->|encodes batch| ETS
    end
    
    subgraph "Text Processing"
        ID[Item Data<br/>name, examine, members]
        CST[create_searchable_text<br/>Format: Item Name + Description]
        FQ[format_query_for_embedding<br/>Format user queries]
        
        ID --> CST
        CST -->|generates| STXT[Searchable Text String]
        UQ[User Query] --> FQ
        FQ -->|generates| FQT[Formatted Query Text]
    end
    
    subgraph "Embedding Generation Flow"
        STXT -->|input| ET
        FQT -->|input| ET
        STXT -->|batch input| ETS
        ET -->|output| EV[Embedding Vector<br/>List of 384 floats]
        ETS -->|output| EVB[Batch Embedding Vectors]
    end
    
    subgraph "PostgreSQL Database with pgvector"
        PG[(PostgreSQL Database)]
        PGV[pgvector Extension<br/>Vector similarity operations]
        PG -->|enables| PGV
        
        subgraph "Item Table (game_items)"
            IT[Item Model]
            ITF1[item_id: Integer PK]
            ITF2[name: String]
            ITF3[examine: Text]
            ITF4[members: Boolean]
            ITF5[embedding: Vector 384]
            ITF6[Other fields:<br/>lowalch, highalch, limit, value, icon]
            
            IT --> ITF1
            IT --> ITF2
            IT --> ITF3
            IT --> ITF4
            IT --> ITF5
            IT --> ITF6
        end
        
        subgraph "Price History Table"
            PH[PriceHistory Model]
            PHF1[id: Integer PK]
            PHF2[item_id: Foreign Key]
            PHF3[timestamp: TIMESTAMP]
            PHF4[high_price: BigInteger]
            PHF5[low_price: BigInteger]
            
            PH --> PHF1
            PH --> PHF2
            PH --> PHF3
            PH --> PHF4
            PH --> PHF5
        end
        
        ITF1 -.->|1:N| PHF2
    end
    
    EV -->|stores| ITF5
    EVB -->|batch stores| ITF5
    ID -->|creates/updates| IT
    
    subgraph "Vector Search Process"
        SQ[Search Query]
        SQ --> FQ
        FQT --> ET
        ET -->|generates| QEV[Query Embedding Vector]
        
        VS[Vector Similarity Search<br/>ORDER BY embedding cosine distance query_vector]
        QEV -->|input| VS
        ITF5 -->|compared with| VS
        PGV -->|provides cosine distance operator| VS
        
        VS -->|returns| SR[Search Results<br/>with similarity scores]
        
        KW[Keyword Matching<br/>Name/description boost]
        SQ -->|also used for| KW
        SR -->|combined with| KW
        KW -->|final| FR[Final Ranked Results]
    end
    
    subgraph "Polling Service Integration"
        PS[Polling Service]
        API[OSRS Wiki API]
        API -->|fetches| PS
        PS -->|processes| ID
        PS -->|batch generates| ETS
        PS -->|stores| IT
    end
    
    style ES fill:#e1f5ff,color:#000000
    style ST fill:#e1f5ff,color:#000000
    style PG fill:#fff4e1,color:#000000
    style PGV fill:#fff4e1,color:#000000
    style IT fill:#e8f5e9,color:#000000
    style ITF5 fill:#ffebee,color:#000000
    style VS fill:#f3e5f5,color:#000000
    style QEV fill:#f3e5f5,color:#000000

